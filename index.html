<!DOCTYPE html>
<html lang="sv">
  <head>
    <meta charset="utf-8" />
    <title>3D Bokstavsvåg (Systemfont)</title>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        background-color: #fff; /* Vit bakgrund */
      }
      canvas {
        display: block;
      }
      #ui {
        position: absolute;
        top: 10px;
        left: 10px;
        color: #000; /* Svart text i UI */
        z-index: 999;
        font-family: sans-serif;
        background: rgba(255, 255, 255, 0.7);
        padding: 10px;
        border-radius: 4px;
      }
      label {
        display: inline-block;
        width: 80px;
      }
    </style>
  </head>
  <body>
    <div id="ui">
      <div>
        <label for="amplitudeSlider">Amplitude</label>
        <input id="amplitudeSlider" type="range" min="0" max="1" step="0.01" value="0.2" />
      </div>
      <div>
        <label for="frequencySlider">Frequency</label>
        <input id="frequencySlider" type="range" min="0" max="10" step="0.1" value="2" />
      </div>
    </div>

    <!-- Använder valfri Three.js-version. Här r151 (ES5/UMD-varianten) -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.151.3/build/three.min.js"></script>

    <script>
      // Texten du vill använda (Pippi-exempel)
      const pippiText = `
Hennes hår hade samma färg som en morot och var flätat i två hårda flätor som stod rätt ut.
Hennes näsa hade samma fason som en mycket liten potatis, och den var alldeles prickig av fräknar.
Under näsan satt en verkligen mycket bred mun med friska, vita tänder.
Hennes klänning var rätt egendomlig. Pippi hade själv sytt den.
Det var meningen att den skulle bli blå, men det blåa tyget räckte inte,
så Pippi fick lov att sy dit lite röda tygbitar här och där.
På hennes långa, smala ben satt ett par långa strumpor, den ena brun och den andra svart.
Och så hade hon ett par svarta skor som var precis dubbelt så långa som hennes fötter.
De skorna hade hennes pappa köpt åt henne i Sydamerika för att hon skulle ha lite att växa i,
och Pippi ville aldrig ha några andra.
      `;

      // Tre globala variabler
      let scene, camera, renderer;

      // Arrayer för alla "bokstavsmesh"
      let letterMeshes = [];

      // För sliders och mus
      let amplitude = 0.2;
      let frequency = 2.0;
      let mouseX = 0;
      let mouseY = 0;

      init();
      animate();

      function init() {
        // Skapa scen och kamera
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(
          45,
          window.innerWidth / window.innerHeight,
          0.1,
          2000
        );
        camera.position.set(0, 0, 800);
        camera.lookAt(scene.position);

        // Renderer
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setClearColor(0xffffff, 1); // Vit bakgrund
        document.body.appendChild(renderer.domElement);

        // Ljus (frivilligt)
        const ambientLight = new THREE.AmbientLight(0xffffff, 1);
        scene.add(ambientLight);

        // Skapa bokstäver som plane-texturer
        createTextPlanes();

        // Event: resize
        window.addEventListener("resize", onWindowResize, false);

        // Sliders
        document.getElementById("amplitudeSlider").addEventListener("input", (e) => {
          amplitude = parseFloat(e.target.value);
        });
        document.getElementById("frequencySlider").addEventListener("input", (e) => {
          frequency = parseFloat(e.target.value);
        });

        // Musposition
        document.addEventListener("mousemove", onMouseMove, false);
      }

      /**
       * Skapar plane-geometry för varje bokstav genom att rita bokstaven på en canvas
       * med systemfont (t.ex. "serif"), sedan göra en Texture av det.
       */
      function createTextPlanes() {
        const lines = pippiText.split("\n");
        const fontSize = 40;  // i pixlar (canvas)
        const lineHeight = 50; // avstånd mellan rader i 3D

        let yOffset = 0; // för att placera raderna

        for (let i = 0; i < lines.length; i++) {
          const line = lines[i].trim();
          if (line.length === 0) {
            yOffset -= lineHeight;
            continue;
          }

          let xOffset = 0;

          for (let j = 0; j < line.length; j++) {
            const char = line[j];
            if (char === " ") {
              xOffset += 20; // ungefärlig bredd på mellanslag
              continue;
            }

            // 1) Skapa en liten canvas
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");

            // Tillfällig storlek först, för att mäta textbredd
            ctx.font = `${fontSize}px serif`;
            const metrics = ctx.measureText(char);
            const textWidth = Math.ceil(metrics.width);
            const textHeight = fontSize; // ungefär, ev. + lite marginal

            // Justera canvasstorlek till texten
            canvas.width = textWidth;
            canvas.height = textHeight;

            // Rita bokstaven på canvas
            ctx.font = `${fontSize}px serif`;
            ctx.fillStyle = "#000"; // svart text
            // Baslinjen i canvas är i nedre kanten, därför justerar vi y med fontSize
            ctx.fillText(char, 0, fontSize * 0.8);

            // 2) Skapa en Texture från canvas
            const texture = new THREE.Texture(canvas);
            texture.needsUpdate = true;

            // 3) PlaneGeometry i 3D, anpassad efter textstorlek
            //    Men vi kan skala ner storleken så att texten inte blir för stor i 3D
            const scaleFactor = 0.4; // justera för att få lagom storlek
            const planeWidth = textWidth * scaleFactor;
            const planeHeight = textHeight * scaleFactor;
            const geometry = new THREE.PlaneGeometry(planeWidth, planeHeight);

            const material = new THREE.MeshBasicMaterial({
              map: texture,
              transparent: true, // så att bakgrunden i canvasen inte syns (om den är blank)
            });

            const mesh = new THREE.Mesh(geometry, material);

            // Spara originalposition
            mesh.userData = {
              originalX: xOffset,
              originalY: yOffset,
            };

            // Placera bokstaven i scenen
            mesh.position.set(xOffset, yOffset, 0);
            scene.add(mesh);
            letterMeshes.push(mesh);

            // Flytta xOffset för nästa bokstav
            xOffset += planeWidth + 5; // lite mellanrum
          }

          // Nästa rad
          yOffset -= lineHeight;
        }

        console.log("Antal bokstavsmesh:", letterMeshes.length);
      }

      function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }

      function onMouseMove(event) {
        mouseX = (event.clientX / window.innerWidth) * 2 - 1;
        mouseY = -(event.clientY / window.innerHeight) * 2 + 1;
      }

      function animate() {
        requestAnimationFrame(animate);

        const time = performance.now() * 0.001;

        // Animerar bokstäverna
        letterMeshes.forEach((mesh, index) => {
          const { originalX, originalY } = mesh.userData;

          // Vågeffekt i Z-led
          const wave = Math.sin(index * 0.1 * frequency + time) * amplitude * 20;

          // Musberoende offset i X/Y
          const mouseInfluenceX = mouseX * 10;
          const mouseInfluenceY = mouseY * 10;

          mesh.position.x = originalX + mouseInfluenceX;
          mesh.position.y = originalY + mouseInfluenceY;
          mesh.position.z = wave;
        });

        renderer.render(scene, camera);
      }
    </script>
  </body>
</html>
