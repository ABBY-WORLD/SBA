<!DOCTYPE html>
<html lang="sv">
  <head>
    <meta charset="utf-8" />
    <title>Hel textsida som våg (porträttformat, transparent)</title>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        background-color: #fff; /* Vit bakgrund på hela sidan */
      }
      #ui {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 999;
        font-family: sans-serif;
        background: rgba(255, 255, 255, 0.7);
        padding: 10px;
        border-radius: 4px;
      }
      label {
        display: inline-block;
        width: 80px;
      }
      #sliders > div {
        margin-bottom: 6px;
      }
    </style>
  </head>
  <body>
    <div id="ui">
      <div id="sliders">
        <div>
          <label for="amplitudeSlider">Amplitude</label>
          <input id="amplitudeSlider" type="range" min="0" max="2" step="0.01" value="0.5" />
        </div>
        <div>
          <label for="frequencySlider">Frequency</label>
          <input id="frequencySlider" type="range" min="0" max="10" step="0.1" value="2" />
        </div>
        <div>
          <label for="fovSlider">FOV</label>
          <input id="fovSlider" type="range" min="10" max="120" step="1" value="45" />
        </div>
      </div>
    </div>

    <!-- Three.js -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.151.3/build/three.min.js"></script>

    <script>
      // ------------------------------------------------
      // 1) Text att använda
      // ------------------------------------------------
      const pippiText = `
Hennes hår hade samma färg som en morot och var flätat i två hårda flätor som stod rätt ut.
Hennes näsa hade samma fason som en mycket liten potatis, och den var alldeles prickig av fräknar.
Under näsan satt en verkligen mycket bred mun med friska, vita tänder.
Hennes klänning var rätt egendomlig. Pippi hade själv sytt den.
Det var meningen att den skulle bli blå, men det blåa tyget räckte inte,
så Pippi fick lov att sy dit lite röda tygbitar här och där.
På hennes långa, smala ben satt ett par långa strumpor, den ena brun och den andra svart.
Och så hade hon ett par svarta skor som var precis dubbelt så långa som hennes fötter.
De skorna hade hennes pappa köpt åt henne i Sydamerika för att hon skulle ha lite att växa i,
och Pippi ville aldrig ha några andra.
      `;

      // ------------------------------------------------
      // 2) Globala variabler
      // ------------------------------------------------
      let scene, camera, renderer;
      let planeMesh; // planet med hela textsidan
      let amplitude = 0.5;
      let frequency = 2.0;

      init();
      animate();

      // ------------------------------------------------
      // 3) Initieringsfunktion
      // ------------------------------------------------
      function init() {
        // Skapa scen och kamera
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(
          45, // initial FOV
          window.innerWidth / window.innerHeight,
          0.1,
          2000
        );
        camera.position.set(0, 0, 600);
        camera.lookAt(scene.position);

        // Renderer
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // Ljus (frivilligt)
        const ambientLight = new THREE.AmbientLight(0xffffff, 1);
        scene.add(ambientLight);

        // Skapa en canvas med ordentlig word-wrap för att efterlikna en bok-/tidningssida
        const { texture, planeWidth, planeHeight } = createTextPageTexture(pippiText);

        // Skapa en plane geometry med segment för en vågform
        // Öka segmentsX/segmentsY för mjukare våg
        const segmentsX = 40;
        const segmentsY = 40;
        const geometry = new THREE.PlaneGeometry(planeWidth, planeHeight, segmentsX, segmentsY);

        // Material med transparent bakgrund (endast text)
        const material = new THREE.MeshBasicMaterial({
          map: texture,
          side: THREE.DoubleSide,
          transparent: true
        });

        // Mesh
        planeMesh = new THREE.Mesh(geometry, material);
        scene.add(planeMesh);

        // (0,0,0) är mittpunkten av planeGeometry → rotation sker runt centrum
        planeMesh.position.set(0, 0, 0);

        // Event: resize
        window.addEventListener("resize", onWindowResize);

        // Sliders
        document.getElementById("amplitudeSlider").addEventListener("input", (e) => {
          amplitude = parseFloat(e.target.value);
        });
        document.getElementById("frequencySlider").addEventListener("input", (e) => {
          frequency = parseFloat(e.target.value);
        });
        document.getElementById("fovSlider").addEventListener("input", (e) => {
          camera.fov = parseFloat(e.target.value);
          camera.updateProjectionMatrix();
        });
      }

      // ------------------------------------------------
      // 4) Skapa en "sida" (canvas) med word-wrap
      // ------------------------------------------------
      function createTextPageTexture(fullText) {
        // Sätt "sidbredd" i pixlar (bokuppslag i porträtt)
        const pageWidth = 400;  // Justera efter smak
        const fontSize = 20;    // px
        const lineHeight = 28;  // px

        // Dela upp texten i stycken
        const paragraphs = fullText.trim().split("\n");

        // Temporär canvas för att mäta text
        const measureCanvas = document.createElement("canvas");
        const measureCtx = measureCanvas.getContext("2d");
        measureCtx.font = `${fontSize}px serif`;

        // Word-wrapa styckena
        let wrappedLines = [];
        paragraphs.forEach((para) => {
          if (!para.trim()) {
            // tom rad
            wrappedLines.push("");
            return;
          }
          const lines = wrapText(para.trim(), pageWidth, measureCtx);
          wrappedLines = wrappedLines.concat(lines);
          wrappedLines.push(""); // blank rad efter varje stycke
        });

        // Räkna ut total höjd
        const totalHeight = wrappedLines.length * lineHeight;
        // Skapa den "riktiga" canvasen
        const textCanvas = document.createElement("canvas");
        textCanvas.width = pageWidth;
        textCanvas.height = totalHeight;

        const ctx = textCanvas.getContext("2d");
        // Om du vill se en vit rektangel bakom texten:
        // ctx.fillStyle = "#ffffff";
        // ctx.fillRect(0, 0, textCanvas.width, textCanvas.height);

        // Skriv svart text
        ctx.fillStyle = "#000000";
        ctx.font = `${fontSize}px serif`;
        let y = fontSize; // startpunkt för texten
        wrappedLines.forEach((line) => {
          ctx.fillText(line, 0, y);
          y += lineHeight;
        });

        // Skapa Three.js-textur
        const texture = new THREE.Texture(textCanvas);
        texture.needsUpdate = true;

        // Skala 1:1 px → world-unit (justera om du vill)
        const planeWidth = pageWidth;
        const planeHeight = totalHeight;

        return {
          texture,
          planeWidth,
          planeHeight
        };
      }

      // ------------------------------------------------
      // 5) Word-wrap-funktion
      // ------------------------------------------------
      function wrapText(text, maxWidth, ctx) {
        const words = text.split(/\s+/);
        let lines = [];
        let currentLine = words[0];

        for (let i = 1; i < words.length; i++) {
          const testLine = currentLine + " " + words[i];
          const testWidth = ctx.measureText(testLine).width;
          if (testWidth > maxWidth) {
            lines.push(currentLine);
            currentLine = words[i];
          } else {
            currentLine = testLine;
          }
        }
        lines.push(currentLine);
        return lines;
      }

      // ------------------------------------------------
      // 6) Animate-loop (våg)
      // ------------------------------------------------
      function animate() {
        requestAnimationFrame(animate);
        const time = performance.now() * 0.001;

        // Justera varje vertex i plane-geom
        const positions = planeMesh.geometry.attributes.position;
        for (let i = 0; i < positions.count; i++) {
          const x = positions.getX(i);
          // Exempel på våg i x-led
          const waveZ = Math.sin((x * 0.03 * frequency) + time) * amplitude * 20;
          positions.setZ(i, waveZ);
        }
        positions.needsUpdate = true;

        renderer.render(scene, camera);
      }

      // ------------------------------------------------
      // 7) Hantera fönsterstorlek
      // ------------------------------------------------
      function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }
    </script>
  </body>
</html>
