<!DOCTYPE html>
<html lang="sv">
  <head>
    <meta charset="utf-8" />
    <title>3D Bokstavsvåg</title>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        background-color: #000; /* Mörk bakgrund */
      }
      canvas {
        display: block;
      }
      #ui {
        position: absolute;
        top: 10px;
        left: 10px;
        color: #fff;
        z-index: 999;
        font-family: sans-serif;
        background: rgba(0, 0, 0, 0.3);
        padding: 10px;
        border-radius: 4px;
      }
      label {
        display: inline-block;
        width: 80px;
      }
    </style>
  </head>
  <body>
    <div id="ui">
      <div>
        <label for="amplitudeSlider">Amplitude</label>
        <input id="amplitudeSlider" type="range" min="0" max="1" step="0.01" value="0.2" />
      </div>
      <div>
        <label for="frequencySlider">Frequency</label>
        <input id="frequencySlider" type="range" min="0" max="10" step="0.1" value="2" />
      </div>
    </div>

    <!-- Three.js -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.min.js"></script>
    <!-- Loader för font-filer -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.150.1/examples/js/loaders/FontLoader.js"></script>
    <!-- Exempel på font (helvetiker_bold) -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.150.1/examples/js/loaders/TextGeometry.js"></script>

    <script>
      // Texten du vill använda
      const pippiText = `
Hennes hår hade samma färg som en morot och var flätat i två hårda flätor som stod rätt ut.
Hennes näsa hade samma fason som en mycket liten potatis, och den var alldeles prickig av fräknar.
Under näsan satt en verkligen mycket bred mun med friska, vita tänder.
Hennes klänning var rätt egendomlig. Pippi hade själv sytt den.
Det var meningen att den skulle bli blå, men det blåa tyget räckte inte,
så Pippi fick lov att sy dit lite röda tygbitar här och där.
På hennes långa, smala ben satt ett par långa strumpor, den ena brun och den andra svart.
Och så hade hon ett par svarta skor som var precis dubbelt så långa som hennes fötter.
De skorna hade hennes pappa köpt åt henne i Sydamerika för att hon skulle ha lite att växa i,
och Pippi ville aldrig ha några andra.
      `;

      let scene, camera, renderer;
      let font;                 // Font laddas in
      let letterMeshes = [];    // Array för alla bokstavsmesh

      // För sliders och mus
      let amplitude = 0.2;
      let frequency = 2.0;
      let mouseX = 0;
      let mouseY = 0;

      init();
      animate();

      function init() {
        // Skapa scen och kamera
        scene = new THREE.Scene();

        camera = new THREE.PerspectiveCamera(
          45, // Field of View
          window.innerWidth / window.innerHeight, // Aspekt
          0.1, // near
          1000 // far
        );
        camera.position.set(0, 0, 300);
        camera.lookAt(scene.position);

        // Renderer
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        // Sätt en färg på "bakgrunden" i Three.js (canvas)
        renderer.setClearColor(0x000000, 1);
        document.body.appendChild(renderer.domElement);

        // Lite ljus
        const ambientLight = new THREE.AmbientLight(0xffffff, 1);
        scene.add(ambientLight);

        // Ladda font
        const fontLoader = new THREE.FontLoader();
        fontLoader.load(
          "https://cdn.jsdelivr.net/npm/three@0.150.1/examples/fonts/helvetiker_bold.typeface.json",
          function (loadedFont) {
            font = loadedFont;
            createText();
          },
          undefined,
          function (error) {
            console.error("Fel vid font-laddning:", error);
          }
        );

        // Lyssna på fönstrets storlek
        window.addEventListener("resize", onWindowResize, false);

        // Sliders
        const amplitudeSlider = document.getElementById("amplitudeSlider");
        amplitudeSlider.addEventListener("input", (e) => {
          amplitude = parseFloat(e.target.value);
        });

        const frequencySlider = document.getElementById("frequencySlider");
        frequencySlider.addEventListener("input", (e) => {
          frequency = parseFloat(e.target.value);
        });

        // Musposition
        document.addEventListener("mousemove", onMouseMove, false);
      }

      function createText() {
        // Dela upp texten i rader
        const lines = pippiText.split("\n");

        let yOffset = 0; // För att placera raderna
        const lineHeight = 12; // Avstånd mellan rader

        // För varje rad
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i].trim();
          if (line.length === 0) {
            // Tom rad
            yOffset -= lineHeight;
            continue;
          }

          let xOffset = 0;
          // Loopa över varje tecken i raden
          for (let j = 0; j < line.length; j++) {
            const char = line[j];

            // Hoppa över mellanslag, eller skapa en "space-geometry" om du vill
            if (char === " ") {
              xOffset += 4; // ungefärlig bredd på mellanslag
              continue;
            }

            // Skapa textgeometri för bokstaven
            const geometry = new THREE.TextGeometry(char, {
              font: font,
              size: 5,
              height: 1,
              curveSegments: 2
            });
            geometry.computeBoundingBox(); // Viktigt för att få boundingBox-värden

            const material = new THREE.MeshBasicMaterial({ color: 0xffffff });
            const mesh = new THREE.Mesh(geometry, material);

            // Originalposition (för animering)
            mesh.userData = {
              originalX: xOffset,
              originalY: yOffset
            };

            // Placera bokstaven
            mesh.position.set(xOffset, yOffset, 0);

            // Lägg till i scenen och i arrayen
            scene.add(mesh);
            letterMeshes.push(mesh);

            // Justera xOffset för nästa bokstav
            const width = geometry.boundingBox.max.x - geometry.boundingBox.min.x;
            xOffset += width + 1; // liten marginal
          }

          // Gå till nästa rad
          yOffset -= lineHeight;
        }

        // Kolla i konsolen hur många bokstäver som skapas
        console.log("Antal bokstavsmesh:", letterMeshes.length);
      }

      function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }

      function onMouseMove(event) {
        // Normalisera musposition mellan -1 och 1
        mouseX = (event.clientX / window.innerWidth) * 2 - 1;
        mouseY = -(event.clientY / window.innerHeight) * 2 + 1;
      }

      function animate() {
        requestAnimationFrame(animate);

        const time = performance.now() * 0.001; // tid i sekunder

        // Uppdatera varje bokstav
        letterMeshes.forEach((mesh, index) => {
          // Hämta originalposition
          const { originalX, originalY } = mesh.userData;

          // Vågeffekt i Z-led
          const wave = Math.sin(index * 0.1 * frequency + time) * amplitude * 10;

          // Musberoende offset
          const mouseInfluenceX = mouseX * 5;
          const mouseInfluenceY = mouseY * 5;

          mesh.position.x = originalX + mouseInfluenceX;
          mesh.position.y = originalY + mouseInfluenceY;
          mesh.position.z = wave;
        });

        renderer.render(scene, camera);
      }
    </script>
  </body>
</html>
