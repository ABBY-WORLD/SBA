<!DOCTYPE html>
<html lang="sv">
  <head>
    <meta charset="utf-8" />
    <title>3D Bokstavsvåg (Systemfont, musrotation)</title>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        background-color: #fff; /* Vit bakgrund */
      }
      canvas {
        display: block;
      }
      #ui {
        position: absolute;
        top: 10px;
        left: 10px;
        color: #000; /* Svart text i UI */
        z-index: 999;
        font-family: sans-serif;
        background: rgba(255, 255, 255, 0.7);
        padding: 10px;
        border-radius: 4px;
      }
      label {
        display: inline-block;
        width: 80px;
      }
      #sliders > div {
        margin-bottom: 6px;
      }
    </style>
  </head>
  <body>
    <div id="ui">
      <div id="sliders">
        <div>
          <label for="amplitudeSlider">Amplitude</label>
          <input id="amplitudeSlider" type="range" min="0" max="1" step="0.01" value="0.2" />
        </div>
        <div>
          <label for="frequencySlider">Frequency</label>
          <input id="frequencySlider" type="range" min="0" max="10" step="0.1" value="2" />
        </div>
        <div>
          <label for="fovSlider">FOV</label>
          <input id="fovSlider" type="range" min="10" max="120" step="1" value="45" />
        </div>
      </div>
    </div>

    <!-- Three.js -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.151.3/build/three.min.js"></script>

    <script>
      // Texten du vill använda (Pippi-exempel)
      const pippiText = `
Hennes hår hade samma färg som en morot och var flätat i två hårda flätor som stod rätt ut.
Hennes näsa hade samma fason som en mycket liten potatis, och den var alldeles prickig av fräknar.
Under näsan satt en verkligen mycket bred mun med friska, vita tänder.
Hennes klänning var rätt egendomlig. Pippi hade själv sytt den.
Det var meningen att den skulle bli blå, men det blåa tyget räckte inte,
så Pippi fick lov att sy dit lite röda tygbitar här och där.
På hennes långa, smala ben satt ett par långa strumpor, den ena brun och den andra svart.
Och så hade hon ett par svarta skor som var precis dubbelt så långa som hennes fötter.
De skorna hade hennes pappa köpt åt henne i Sydamerika för att hon skulle ha lite att växa i,
och Pippi ville aldrig ha några andra.
      `;

      let scene, camera, renderer;
      let textGroup;            // Grupp för alla bokstäver
      let letterMeshes = [];    // Array för bokstavsmesh

      // För sliders och mus
      let amplitude = 0.2;
      let frequency = 2.0;
      let mouseX = 0;
      let mouseY = 0;

      init();
      animate();

      function init() {
        // Skapa scen och kamera
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(
          45, // initial FOV
          window.innerWidth / window.innerHeight,
          0.1,
          2000
        );
        camera.position.set(0, 0, 800);
        camera.lookAt(scene.position);

        // Renderer
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setClearColor(0xffffff, 1); // Vit bakgrund
        document.body.appendChild(renderer.domElement);

        // Ljus
        const ambientLight = new THREE.AmbientLight(0xffffff, 1);
        scene.add(ambientLight);

        // Grupp som håller all text
        textGroup = new THREE.Group();
        scene.add(textGroup);

        // Skapa bokstäver som plane-texturer (systemfont)
        createTextPlanes();

        // Centrera och skala ned gruppen (utan att rotera)
        centerText();

        // Event: resize
        window.addEventListener("resize", onWindowResize, false);

        // Sliders
        document.getElementById("amplitudeSlider").addEventListener("input", (e) => {
          amplitude = parseFloat(e.target.value);
        });
        document.getElementById("frequencySlider").addEventListener("input", (e) => {
          frequency = parseFloat(e.target.value);
        });
        document.getElementById("fovSlider").addEventListener("input", (e) => {
          camera.fov = parseFloat(e.target.value);
          camera.updateProjectionMatrix();
        });

        // Musposition
        document.addEventListener("mousemove", onMouseMove, false);
      }

      /**
       * Skapar plane-geometry för varje bokstav genom att rita bokstaven på en canvas
       * med systemfont (t.ex. "serif"), sedan göra en Texture av det.
       */
      function createTextPlanes() {
        const lines = pippiText.split("\n");
        const fontSize = 40;   // i pixlar (Canvas)
        const lineHeight = 40; // RADAVSTÅND nu 40 (tidigare 50)

        let yOffset = 0;

        for (let i = 0; i < lines.length; i++) {
          const line = lines[i].trim();
          if (line.length === 0) {
            yOffset -= lineHeight;
            continue;
          }

          let xOffset = 0;

          for (let j = 0; j < line.length; j++) {
            const char = line[j];
            if (char === " ") {
              xOffset += 20; // ungefärlig bredd på mellanslag
              continue;
            }

            // 1) Skapa en liten canvas för bokstaven
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");

            ctx.font = `${fontSize}px serif`;
            const metrics = ctx.measureText(char);
            const textWidth = Math.ceil(metrics.width);
            const textHeight = fontSize;

            canvas.width = textWidth;
            canvas.height = textHeight;

            // Rita bokstaven
            ctx.font = `${fontSize}px serif`;
            ctx.fillStyle = "#000"; // svart text
            ctx.fillText(char, 0, fontSize * 0.8);

            // 2) Skapa en Texture från canvas
            const texture = new THREE.Texture(canvas);
            texture.needsUpdate = true;

            // 3) PlaneGeometry
            const scaleFactor = 0.4; // storlek i 3D
            const planeWidth = textWidth * scaleFactor;
            const planeHeight = textHeight * scaleFactor;
            const geometry = new THREE.PlaneGeometry(planeWidth, planeHeight);

            const material = new THREE.MeshBasicMaterial({
              map: texture,
              transparent: true, // bakgrund blir genomskinlig
            });

            const mesh = new THREE.Mesh(geometry, material);

            // Originalposition
            mesh.userData = {
              originalX: xOffset,
              originalY: yOffset,
            };

            // Placera bokstaven i gruppen
            mesh.position.set(xOffset, yOffset, 0);
            textGroup.add(mesh);
            letterMeshes.push(mesh);

            // Nästa bokstav
            xOffset += planeWidth + 5;
          }
          // Nästa rad
          yOffset -= lineHeight;
        }

        console.log("Antal bokstavsmesh:", letterMeshes.length);
      }

      /**
       * Centrerar textgruppen i (0,0,0) och skalar ned den lite
       * utan att sätta en initial rotation (vi roterar med musen istället).
       */
      function centerText() {
        const box = new THREE.Box3().setFromObject(textGroup);
        const center = box.getCenter(new THREE.Vector3());
        textGroup.position.x = -center.x;
        textGroup.position.y = -center.y;
        textGroup.scale.set(0.7, 0.7, 0.7);
      }

      function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }

      function onMouseMove(event) {
        // Normalisera musposition till -1..1
        mouseX = (event.clientX / window.innerWidth) * 2 - 1;
        mouseY = -(event.clientY / window.innerHeight) * 2 + 1;
      }

      function animate() {
        requestAnimationFrame(animate);
        const time = performance.now() * 0.001;

        // 1) Rotera hela textGroup baserat på musen
        //    Känn dig fri att justera multiplikatorerna för att få lagom rotation.
        textGroup.rotation.x = mouseY * 2;
        textGroup.rotation.y = mouseX * 2;
        // Om du vill rotera i Z-led också:
        // textGroup.rotation.z = (mouseX + mouseY) * 1.0;

        // 2) Animerar bokstäverna i en vågrörelse (AMPLITUD * 40 = dubbelt så stor mot tidigare 20)
        letterMeshes.forEach((mesh, index) => {
          const { originalX, originalY } = mesh.userData;
          const wave = Math.sin(index * 0.1 * frequency + time) * amplitude * 40;

          // Musberoende offset i X/Y (valfritt, kan justeras)
          const mouseInfluenceX = mouseX * 10;
          const mouseInfluenceY = mouseY * 10;

          mesh.position.x = originalX + mouseInfluenceX;
          mesh.position.y = originalY + mouseInfluenceY;
          mesh.position.z = wave;
        });

        renderer.render(scene, camera);
      }
    </script>
  </body>
</html>
